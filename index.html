<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no" />

<!--odsud dal-->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.4.2/ol.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/4.4.2/ol.js"></script>
<script src="./data/data.js"></script>


<div id="mapdiv">
	<div id="select"></div>
	<div id="tooltip">Najetím vyberte obec.</div>
	<div id="map" class="map"></div>
	<div id="legend">
		<div id="scale"></div>
		<span class="zisk">zisk</span>
		<span class="ztrata">ztráta</span>
	</div>
	 <form action="?" id='frm-geocode'>
	  <label for="inp-geocode">Najít adresu</label>
	  <div class="inputs">
	    <input type="text" id="inp-geocode" placeholder="Bruntál">
	    <input type="submit" value="Najít">
	  </div>
	</form>
</div>

<script>

function getColor(val) {
    var col = 'green';
    if (typeof data[val] != 'undefined') {
        if (data[val]['sucho'] >= 0.3) {
            col = 'red';
        }
    }
    
    var style = new ol.style.Style({
        stroke: new ol.style.Stroke({
        color: "lightgray",
        width: 0.7
        }),
        fill: new ol.style.Fill({
        color: col
        })
    });
    return style;
};


function makeTooltip(evt) {
    document.getElementById('tooltip').innerHTML = 'ahoj'
};

var tilegrid = ol.tilegrid.createXYZ({tileSize: 512, maxZoom: 12});

var background = new ol.layer.Tile({
  source: new ol.source.OSM({
    url: 'https://interaktivni.rozhlas.cz/tiles/ton_b1/{z}/{x}/{y}.png',
    attributions: [
      new ol.Attribution({ html: 'obrazový podkres <a target="_blank" href="http://stamen.com">Stamen</a>, <a target="_blank" href="https://samizdat.cz">Samizdat</a>, data <a target="_blank" href="https://www.czso.cz/csu/czso/uchazeci-o-zamestnani-dosazitelni-a-podil-nezamestnanych-osob-podle-obci">ČSÚ</a>'})
    ]
  })
})

var labels = new ol.layer.Tile({
  source: new ol.source.OSM({
    url: 'https://interaktivni.rozhlas.cz/tiles/ton_l1/{z}/{x}/{y}.png',
    maxZoom: 11
  })
})

var layer = new ol.layer.VectorTile({
source: new ol.source.VectorTile({
    format: new ol.format.MVT(),
    tileGrid: tilegrid,
    tilePixelRatio: 8,
    url: 'tiles/{z}/{x}/{y}.pbf'
}),
    style: function(feature) {
        return getColor(feature.get('Kod'))
    }
});

var initZoom;

if (window.innerWidth < 768) {
initZoom = 6;
document.getElementById('tooltip').innerHTML = 'Kliknutím vyberte obec.'
} else {
initZoom = 7;
}

var map = new ol.Map({
interactions: ol.interaction.defaults({mouseWheelZoom:false}),
target: 'map',
view: new ol.View({
    center: ol.proj.transform([15.3350758, 49.7417517], 'EPSG:4326', 'EPSG:3857'), //Číhošť
    zoom: initZoom,
    minZoom: 6,
    maxZoom: 11
})
});

map.addLayer(background);
map.addLayer(layer);
map.addLayer(labels);

map.on('pointermove', function(evt) {
if (evt.dragging) {
    return;
}
var pixel = map.getEventPixel(evt.originalEvent);
if (map.hasFeatureAtPixel(pixel)){
    map.forEachFeatureAtPixel(pixel, function(feature, layer) {
        makeTooltip(feature.c);
    });
} else {
    document.getElementById('tooltip').innerHTML = 'Najetím vyberte obec.'
}
});

//mobil
map.on('singleclick', function(evt) {
var pixel = map.getEventPixel(evt.originalEvent);
if (map.hasFeatureAtPixel(pixel)){
    map.forEachFeatureAtPixel(pixel, function(feature, layer) {
        makeTooltip(feature.c);
    });
} else {
    document.getElementById('tooltip').innerHTML = 'Kliknutím vyberte obec.'
}
});

var form = document.getElementById("frm-geocode");
var geocoder = null;
var geocodeMarker = null;
form.onsubmit = function(event) {
event.preventDefault();
var text = document.getElementById("inp-geocode").value;
if (text == '') {
map.getView().setCenter(ol.proj.transform([15.3350758, 49.7417517], 'EPSG:4326', 'EPSG:3857'))
map.getView().setZoom(8)
} else {
$.get( "https://api.mapy.cz/geocode?query=" + text, function(data) {
    if (typeof $(data).find('item').attr('x') == 'undefined') {
    alert("Bohužel, danou adresu nebylo možné najít");
    return;
    }
    var x = parseFloat($(data).find('item').attr('x'))
    var y = parseFloat($(data).find('item').attr('y'))
    map.getView().setCenter(ol.proj.transform([x, y], 'EPSG:4326', 'EPSG:3857'))
    map.getView().setZoom(12)
}, 'xml');
} 
};
</script>